### Spring Cloud 组件简单介绍

- **eureka**：服务发现与注册。eureka中设计了两级缓存来维护服务注册表。其中用两个同步机制。ReadWriteCache实时同步注册表的变动，ReadOnlyCache以一定的策略（定时同步，配置定时时长）去从ReadWriteCache同步新的数据。服务发现则是从ReadOnlyCache去获取注册表数据。
- **Hystrix**：断路器。发起请求是通过Hystrix的线程来走的，不同服务走不同的线程池，实现了不同服务调用的隔离，通过统计接口超时次数返回默认值，实现服务熔断和降级。
- **Zuul**：用来实现微服务网关。通常是配合服务发现组件使用。zuul微服务注册到eureka上去。请求都走向网关，根据路由策略去转发请求到对应的微服务。路由规则可在配置文件配置，也可以设计一套动态的规则，系统部署后，从通过持久层获取自定义的路由信息，写到路由表中去。另外也有过滤器机制，可以处理一些校验逻辑。
- 



### 面试

#### 1.zk和eureka有什么区别？

CAP：一致性、可用性、分区容错性

zk：符合CP，强一致性。主从机制。用来资源统一管理。当需要进行leader选举时，zk服务是不可用的。

Eureka：符合AP，高可用性。各个节点都是平等的。只要有一台eureka还在就能保证服务注册可用（高可用性）。但可能查到的信息不是最新的，因为不保证强一致性。

#### 2.分布式锁

- 数据库：非阻塞，不可重入
- redis：setnx。
  - 只有在key不存在的情况下会为key设置值。value中可以放线程唯一标识，避免其他线程释放错锁。
  - 流程：
    - A setnx，获得锁，并设置超时时间戳。
    - 线程B get获取锁的超时时间t1，与当前比较，没超时false
    - 超时则计算新的超时时间t2，使用getset返回t3，如果与t1不相等则说明有人改过，返回false。
- zk：

#### 3.分布式事务

> https://blog.csdn.net/oldshaui/article/details/88743085?utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7Edefault-6.control&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7Edefault-6.control

- 场景
  - 同一个服务涉及到多个库
  - 多个服务关联调用，且涉及到多个库
- 解决方案
  - 基于XA协议--二段提交
    - 两阶段提交由**协调者**和**参与者**组成，共经过两个阶段和三个操作。
    - 第一阶段：协调者通知参与者，参与者开始投票，告知协调者yes or no
    - 第二阶段：协调者根据参与者的投票结果发起最终的提交。如果有参与者没有准备好则回滚。
    - 单点故障：事务管理器出现故障导致系统不可用；响应时间长；
  - 基于XA协议--三段提交
    - 解决了2PC单点故障问题、参与者引入超时机制避免事务管理器挂了参与者一直等待
    - 第一阶段：确认数据库正常
    - 第二阶段，发送sql，完成sql操作
    - 第三阶段：整体提交
  - 基于事务补偿机制的：TTC(Try,Commit,Cancel)，基于业务层面实现
    - 保存数据的最终一致性，灵活控制，但由于是业务代码层面，开发成本高。
  - 基于事务消息：MQ
  - 本地消息表：基于本地数据库+mq，维护本地状态，通过mq调用服务，完成后响应一条消息回调，讲状态改成完成。配合定时任务扫表，重新发送调用服务，需要保证幂等性

#### 4.base理论

basically available 基本可用：允许相应延长 服务降级等

soft state 软状态：指允许系统中的数据存在中间状态，并认为该中间状态不会影响系统整体可用性

eventually consistent 最终一致性



#### 5.分布式会话

- 利用反向代理，将会话分配到其中一台服务器去处理
  - 单机故障问题
- redis存储session
  - 可做集群，可搭建主从

#### 6.Quorum机制



#### 7. waro机制

一种简单的副本控制协议。写操作时只有所有副本更新成功才算成功，只要有一个副本存活，读就成功

#### 8.SOA

面向服务的架构，服务之间相互依赖完成一系列功能。各服务通过ESB（企业服务总线）进行交互，解决异构系统之间的连通性。
